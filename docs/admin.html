<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>× ×™×”×•×œ ××§×•×¨×•×ª â€” Admin</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        .auth-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .auth-box {
            background: #fff;
            border-radius: 16px;
            padding: 32px;
            max-width: 440px;
            width: 90%;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }
        .auth-box h2 { margin-bottom: 8px; font-size: 1.3rem; }
        .auth-box p { color: #555; font-size: 0.9rem; margin-bottom: 16px; line-height: 1.5; }
        .auth-box input {
            width: 100%; padding: 10px 12px; border: 1px solid #e2e8f0;
            border-radius: 8px; font-family: monospace; font-size: 0.9rem;
            direction: ltr; margin-bottom: 12px;
        }
        .auth-box input:focus { outline: none; border-color: #2563eb; box-shadow: 0 0 0 3px #dbeafe; }
        .auth-error { color: #dc2626; font-size: 0.85rem; margin-bottom: 8px; min-height: 20px; }
        .admin-content { display: none; }
        .admin-content.visible { display: block; }
        .save-bar {
            position: sticky; top: 0; z-index: 100;
            background: #fef3c7; border-bottom: 2px solid #f59e0b;
            padding: 12px 20px; display: none; align-items: center;
            justify-content: space-between; gap: 12px;
        }
        .save-bar.visible { display: flex; }
        .save-bar__text { font-size: 0.9rem; font-weight: 500; color: #92400e; }
        .token-bar {
            background: var(--color-surface); border-bottom: 1px solid var(--color-border);
            padding: 8px 20px; display: flex; align-items: center;
            justify-content: space-between; font-size: 0.8rem; color: var(--color-text-secondary);
        }
        .token-bar button { font-size: 0.8rem; }
        .repo-setup { margin-bottom: 20px; }
        .repo-setup input {
            padding: 8px 12px; border: 1px solid var(--color-border);
            border-radius: 8px; font-family: inherit; font-size: 0.9rem;
            direction: ltr; width: 300px;
        }
    </style>
</head>
<body>
    <!-- Auth Overlay -->
    <div class="auth-overlay" id="authOverlay">
        <div class="auth-box">
            <h2>×”×ª×—×‘×¨×•×ª ×œ× ×™×”×•×œ ××§×•×¨×•×ª</h2>
            <p>
                ×”×›× ×¡ GitHub Personal Access Token ×›×“×™ ×œ× ×”×œ ××§×•×¨×•×ª.
                <br>×”-Token ×¦×¨×™×š ×”×¨×©××ª <strong>repo</strong> (×§×¨×™××” + ×›×ª×™×‘×”).
                <br><a href="https://github.com/settings/tokens/new?scopes=repo&description=AI-Cyber-Monitor-Admin" target="_blank" rel="noopener" style="color: #2563eb;">×¦×•×¨ Token ×—×“×©</a>
            </p>
            <input type="password" id="tokenInput" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx" autocomplete="off">
            <div class="auth-error" id="authError"></div>
            <div style="display: flex; gap: 8px;">
                <button class="btn btn--primary" id="loginBtn">×”×ª×—×‘×¨</button>
                <a href="index.html" class="btn" style="text-decoration: none; background: #e2e8f0; color: #333;">×—×–×¨×” ×œ×“×©×‘×•×¨×“</a>
            </div>
        </div>
    </div>

    <!-- Token Bar -->
    <div class="token-bar" id="tokenBar" style="display: none;">
        <span>××—×•×‘×¨ ×œ×¨×™×¤×•: <strong id="repoDisplay"></strong></span>
        <div style="display: flex; gap: 8px;">
            <button class="btn btn--small" style="background: #e2e8f0;" onclick="window.location.href='index.html'">×“×©×‘×•×¨×“</button>
            <button class="btn btn--small btn--danger" id="logoutBtn">×”×ª× ×ª×§</button>
        </div>
    </div>

    <!-- Save Bar (shows when there are unsaved changes) -->
    <div class="save-bar" id="saveBar">
        <span class="save-bar__text">×™×© ×©×™× ×•×™×™× ×©×œ× × ×©××¨×•</span>
        <div style="display: flex; gap: 8px;">
            <button class="btn btn--primary" id="saveBtn">×©××•×¨ ×œ×¨×™×¤×•</button>
            <button class="btn" style="background: #e2e8f0;" id="discardBtn">×‘×˜×œ ×©×™× ×•×™×™×</button>
        </div>
    </div>

    <div class="admin-content" id="adminContent">
        <header class="header">
            <div class="container">
                <h1 class="header__title">× ×™×”×•×œ ××§×•×¨×•×ª</h1>
                <p class="header__subtitle">×”×•×¡×¤×”, ×”×¡×¨×” ×•×”×¤×¢×œ×”/×”×©×‘×ª×” ×©×œ ××§×•×¨×•×ª ×—×“×©×•×ª</p>
            </div>
        </header>

        <main class="container">
            <!-- Repo Setup -->
            <section class="repo-setup" id="repoSetup" style="display: none;">
                <div class="add-source-form">
                    <h2>×”×’×“×¨×ª ×¨×™×¤×•</h2>
                    <p style="color: var(--color-text-secondary); font-size: 0.9rem; margin-bottom: 12px;">
                        ×”×›× ×¡ ××ª ×©× ×”×¨×™×¤×• ×‘×¤×•×¨××˜ <code>owner/repo-name</code>
                    </p>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <input type="text" id="repoInput" placeholder="username/ai-cyber-monitor" dir="ltr">
                        <button class="btn btn--primary" id="setRepoBtn">×©××•×¨</button>
                    </div>
                </div>
            </section>

            <!-- Add Source Form -->
            <section class="add-source-form">
                <h2>×”×•×¡×¤×ª ××§×•×¨ ×—×“×©</h2>
                <div class="form-group">
                    <label for="sourceName">×©× ×”××§×•×¨</label>
                    <input type="text" id="sourceName" placeholder="×œ×“×•×’××”: OpenAI Blog">
                </div>
                <div class="form-group">
                    <label for="sourceUrl">×›×ª×•×‘×ª ×”××ª×¨</label>
                    <input type="url" id="sourceUrl" placeholder="https://openai.com" dir="ltr">
                </div>
                <div class="form-group">
                    <label for="sourceRssUrl">×›×ª×•×‘×ª RSS (××•×¤×¦×™×•× ×œ×™)</label>
                    <input type="url" id="sourceRssUrl" placeholder="https://openai.com/news/rss.xml" dir="ltr">
                </div>
                <div class="form-group">
                    <label for="sourceCategory">×§×˜×’×•×¨×™×”</label>
                    <select id="sourceCategory">
                        <option value="ai">ğŸ¤– AI</option>
                        <option value="cyber">ğŸ”’ ×¡×™×™×‘×¨</option>
                    </select>
                </div>
                <button class="btn btn--primary" id="addSourceBtn">×”×•×¡×£ ××§×•×¨</button>
                <span id="addSourceMsg" style="margin-right: 12px; font-size: 0.9rem;"></span>
            </section>

            <!-- Sources Table -->
            <section style="margin-top: 24px;">
                <h2 style="margin-bottom: 16px; font-size: 1.3rem;">
                    ××§×•×¨×•×ª (<span id="sourceCount">0</span>)
                </h2>
                <table class="sources-table">
                    <thead>
                        <tr>
                            <th>×©×</th>
                            <th>×§×˜×’×•×¨×™×”</th>
                            <th>×©×™×˜×”</th>
                            <th>×¡×˜×˜×•×¡</th>
                            <th>×¤×¢×•×œ×•×ª</th>
                        </tr>
                    </thead>
                    <tbody id="sourcesBody">
                        <tr><td colspan="5" style="text-align: center;">×˜×•×¢×Ÿ...</td></tr>
                    </tbody>
                </table>
            </section>

            <!-- Recipients Management -->
            <section style="margin-top: 36px;">
                <h2 style="margin-bottom: 8px; font-size: 1.3rem;">×¨×©×™××ª ×ª×¤×•×¦×” ×œ××™××™×™×œ</h2>
                <p style="color: var(--color-text-secondary); font-size: 0.9rem; margin-bottom: 16px;">
                    ×”×•×¡×£ ×›×ª×•×‘×•×ª ××™××™×™×œ ×©×™×§×‘×œ×• ××ª ×”×“×•×— ×”×™×•××™. ×”××™××™×™×œ ×”×¨××©×™ (EMAIL_ADDRESS) ×ª××™×“ ××§×‘×œ.
                </p>
                <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 16px;">
                    <input type="email" id="newRecipientEmail" placeholder="user@example.com" dir="ltr"
                           style="padding: 8px 12px; border: 1px solid var(--color-border); border-radius: 8px; font-size: 0.9rem; width: 300px;">
                    <input type="text" id="newRecipientName" placeholder="×©× (××•×¤×¦×™×•× ×œ×™)"
                           style="padding: 8px 12px; border: 1px solid var(--color-border); border-radius: 8px; font-size: 0.9rem; width: 200px;">
                    <button class="btn btn--primary" id="addRecipientBtn">×”×•×¡×£</button>
                    <span id="addRecipientMsg" style="font-size: 0.9rem;"></span>
                </div>
                <table class="sources-table" id="recipientsTable">
                    <thead>
                        <tr>
                            <th>××™××™×™×œ</th>
                            <th>×©×</th>
                            <th>×¡×˜×˜×•×¡</th>
                            <th>×¤×¢×•×œ×•×ª</th>
                        </tr>
                    </thead>
                    <tbody id="recipientsBody">
                        <tr><td colspan="4" style="text-align: center;">×˜×•×¢×Ÿ...</td></tr>
                    </tbody>
                </table>
            </section>

            <!-- Status Log -->
            <section style="margin-top: 24px; margin-bottom: 40px;">
                <div id="statusLog" style="font-size: 0.85rem; color: var(--color-text-secondary);"></div>
            </section>
        </main>
    </div>

    <script>
    (function() {
        "use strict";

        const STORAGE_KEY_TOKEN = "acm_github_token";
        const STORAGE_KEY_REPO = "acm_github_repo";
        const SOURCES_PATH = "config/sources.json";
        const RECIPIENTS_PATH = "config/recipients.json";

        let token = "";
        let repo = "";
        let sources = [];
        let originalJson = "";
        let fileSha = "";
        let recipients = [];
        let originalRecipientsJson = "";
        let recipientsFileSha = "";
        let hasChanges = false;

        // DOM
        const authOverlay = document.getElementById("authOverlay");
        const tokenBar = document.getElementById("tokenBar");
        const adminContent = document.getElementById("adminContent");
        const saveBar = document.getElementById("saveBar");
        const repoDisplay = document.getElementById("repoDisplay");
        const authError = document.getElementById("authError");
        const sourcesBody = document.getElementById("sourcesBody");
        const sourceCount = document.getElementById("sourceCount");
        const statusLog = document.getElementById("statusLog");
        const recipientsBody = document.getElementById("recipientsBody");

        // === Auth ===

        function detectRepoFromUrl() {
            // GitHub Pages URL: username.github.io/repo-name/
            const host = window.location.hostname;
            const path = window.location.pathname;
            if (host.endsWith(".github.io")) {
                const username = host.replace(".github.io", "");
                const repoName = path.split("/").filter(Boolean)[0];
                if (username && repoName) {
                    return `${username}/${repoName}`;
                }
            }
            return "";
        }

        function init() {
            console.log("[admin] init start");
            token = localStorage.getItem(STORAGE_KEY_TOKEN) || "";
            repo = localStorage.getItem(STORAGE_KEY_REPO) || "";

            // Auto-detect repo from GitHub Pages URL if not set
            if (!repo) {
                const detected = detectRepoFromUrl();
                if (detected) {
                    console.log("[admin] auto-detected repo:", detected);
                    repo = detected;
                    localStorage.setItem(STORAGE_KEY_REPO, repo);
                }
            }

            console.log("[admin] token:", token ? "set" : "empty", "repo:", repo || "empty");

            if (token) {
                verifyToken();
            }
        }

        async function verifyToken() {
            try {
                const resp = await ghApi("/user");
                if (!resp.ok) throw new Error("Token ×œ× ×ª×§×™×Ÿ");
                authOverlay.style.display = "none";
                tokenBar.style.display = "flex";
                adminContent.classList.add("visible");

                if (!repo) {
                    document.getElementById("repoSetup").style.display = "block";
                    repoDisplay.textContent = "×œ× ×”×•×’×“×¨";
                    sourcesBody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #f59e0b;">×™×© ×œ×”×’×“×™×¨ ×¨×™×¤×• ×œ××¢×œ×” ×›×“×™ ×œ×˜×¢×•×Ÿ ××§×•×¨×•×ª</td></tr>';
                } else {
                    repoDisplay.textContent = repo;
                    loadSourcesFromRepo();
                    loadRecipientsFromRepo();
                }
            } catch (e) {
                localStorage.removeItem(STORAGE_KEY_TOKEN);
                token = "";
                authError.textContent = "Token ×œ× ×ª×§×™×Ÿ ××• ×¤×’ ×ª×•×§×£. × ×¡×” ×©×•×‘.";
            }
        }

        document.getElementById("loginBtn").addEventListener("click", () => {
            const val = document.getElementById("tokenInput").value.trim();
            if (!val) {
                authError.textContent = "× × ×œ×”×›× ×™×¡ Token";
                return;
            }
            token = val;
            localStorage.setItem(STORAGE_KEY_TOKEN, token);
            authError.textContent = "";
            verifyToken();
        });

        document.getElementById("tokenInput").addEventListener("keydown", (e) => {
            if (e.key === "Enter") document.getElementById("loginBtn").click();
        });

        document.getElementById("logoutBtn").addEventListener("click", () => {
            localStorage.removeItem(STORAGE_KEY_TOKEN);
            token = "";
            window.location.reload();
        });

        document.getElementById("setRepoBtn").addEventListener("click", () => {
            const val = document.getElementById("repoInput").value.trim();
            if (!val || !val.includes("/")) {
                alert("×¤×•×¨××˜ × ×“×¨×©: owner/repo-name");
                return;
            }
            repo = val;
            localStorage.setItem(STORAGE_KEY_REPO, repo);
            repoDisplay.textContent = repo;
            document.getElementById("repoSetup").style.display = "none";
            loadSourcesFromRepo();
            loadRecipientsFromRepo();
        });

        // === GitHub API ===

        function ghApi(path, options = {}) {
            const base = "https://api.github.com";
            const url = path.startsWith("http") ? path : `${base}${path}`;
            return fetch(url, {
                ...options,
                headers: {
                    "Authorization": `Bearer ${token}`,
                    "Accept": "application/vnd.github.v3+json",
                    "Content-Type": "application/json",
                    ...(options.headers || {}),
                },
            });
        }

        async function loadSourcesFromRepo() {
            log("×˜×•×¢×Ÿ ××§×•×¨×•×ª ××”×¨×™×¤×•...");
            console.log("[admin] loading sources from", repo);
            try {
                const apiUrl = `/repos/${repo}/contents/${SOURCES_PATH}`;
                console.log("[admin] API call:", apiUrl);
                const resp = await ghApi(apiUrl);
                console.log("[admin] response status:", resp.status);
                if (!resp.ok) {
                    const errBody = await resp.text();
                    console.error("[admin] error body:", errBody);
                    if (resp.status === 404) {
                        log("×§×•×‘×¥ sources.json ×œ× × ××¦× ×‘×¨×™×¤×•. ×‘×“×•×§ ×©× ×¨×™×¤×•: " + repo);
                        sources = [];
                        fileSha = "";
                        originalJson = JSON.stringify({ sources: [] }, null, 2);
                        renderSources();
                        return;
                    }
                    if (resp.status === 403) {
                        log("××™×Ÿ ×”×¨×©××”. ×•×“× ×©×”-Token ×›×•×œ×œ ×”×¨×©××ª Contents: Read ×œ×¨×™×¤×• " + repo);
                        return;
                    }
                    throw new Error(`×©×’×™××” ${resp.status}: ${errBody}`);
                }
                const data = await resp.json();
                fileSha = data.sha;
                const raw = atob(data.content.replace(/\n/g, ""));
                const bytes = new Uint8Array(raw.length);
                for (let i = 0; i < raw.length; i++) bytes[i] = raw.charCodeAt(i);
                const content = new TextDecoder("utf-8").decode(bytes);
                console.log("[admin] decoded content length:", content.length);
                const parsed = JSON.parse(content);
                sources = parsed.sources || [];
                originalJson = JSON.stringify({ sources }, null, 2);
                renderSources();
                log(`× ×˜×¢× ×• ${sources.length} ××§×•×¨×•×ª ××”×¨×™×¤×•.`);
            } catch (e) {
                console.error("[admin] load error:", e);
                log(`×©×’×™××” ×‘×˜×¢×™× ×”: ${e.message}`);
                sourcesBody.innerHTML = `<tr><td colspan="5" style="text-align: center; color: #dc2626;">×©×’×™××”: ${esc(e.message)}</td></tr>`;
            }
        }

        async function saveToRepo() {
            log("×©×•××¨ ×©×™× ×•×™×™× ×œ×¨×™×¤×•...");
            document.getElementById("saveBtn").disabled = true;

            try {
                // Save sources
                const newSourcesContent = JSON.stringify({ sources }, null, 2);
                const sourcesEncoded = btoa(unescape(encodeURIComponent(newSourcesContent)));
                const sourcesBody = {
                    message: "Update sources.json via admin dashboard",
                    content: sourcesEncoded,
                    branch: "main",
                };
                if (fileSha) sourcesBody.sha = fileSha;

                const resp = await ghApi(`/repos/${repo}/contents/${SOURCES_PATH}`, {
                    method: "PUT",
                    body: JSON.stringify(sourcesBody),
                });
                if (!resp.ok) {
                    const err = await resp.json();
                    throw new Error(err.message || `×©×’×™××” ${resp.status}`);
                }
                const result = await resp.json();
                fileSha = result.content.sha;
                originalJson = newSourcesContent;

                // Save recipients
                await saveRecipientsToRepo();

                hasChanges = false;
                saveBar.classList.remove("visible");
                log("×”×©×™× ×•×™×™× × ×©××¨×• ×‘×”×¦×œ×—×”! ×”×¡×¨×™×§×” ×”×‘××” ×ª×©×ª××© ×‘×”×’×“×¨×•×ª ×”××¢×•×“×›× ×•×ª.");
            } catch (e) {
                log(`×©×’×™××” ×‘×©××™×¨×”: ${e.message}`);
            }
            document.getElementById("saveBtn").disabled = false;
        }

        // === Recipients ===

        async function loadRecipientsFromRepo() {
            try {
                const resp = await ghApi(`/repos/${repo}/contents/${RECIPIENTS_PATH}`);
                if (!resp.ok) {
                    if (resp.status === 404) {
                        recipients = [];
                        recipientsFileSha = "";
                        originalRecipientsJson = JSON.stringify({ recipients: [] }, null, 2);
                        renderRecipients();
                        return;
                    }
                    throw new Error(`×©×’×™××” ${resp.status}`);
                }
                const data = await resp.json();
                recipientsFileSha = data.sha;
                const raw = atob(data.content.replace(/\n/g, ""));
                const bytes = new Uint8Array(raw.length);
                for (let i = 0; i < raw.length; i++) bytes[i] = raw.charCodeAt(i);
                const content = new TextDecoder("utf-8").decode(bytes);
                const parsed = JSON.parse(content);
                recipients = parsed.recipients || [];
                originalRecipientsJson = JSON.stringify({ recipients }, null, 2);
                renderRecipients();
            } catch (e) {
                console.error("[admin] recipients load error:", e);
                recipientsBody.innerHTML = `<tr><td colspan="4" style="text-align: center; color: #dc2626;">×©×’×™××”: ${esc(e.message)}</td></tr>`;
            }
        }

        async function saveRecipientsToRepo() {
            const newContent = JSON.stringify({ recipients }, null, 2);
            const encoded = btoa(unescape(encodeURIComponent(newContent)));
            try {
                const body = {
                    message: "Update recipients.json via admin dashboard",
                    content: encoded,
                    branch: "main",
                };
                if (recipientsFileSha) body.sha = recipientsFileSha;
                const resp = await ghApi(`/repos/${repo}/contents/${RECIPIENTS_PATH}`, {
                    method: "PUT",
                    body: JSON.stringify(body),
                });
                if (!resp.ok) {
                    const err = await resp.json();
                    throw new Error(err.message || `×©×’×™××” ${resp.status}`);
                }
                const result = await resp.json();
                recipientsFileSha = result.content.sha;
                originalRecipientsJson = newContent;
                return true;
            } catch (e) {
                log(`×©×’×™××” ×‘×©××™×¨×ª × ××¢× ×™×: ${e.message}`);
                return false;
            }
        }

        function renderRecipients() {
            if (recipients.length === 0) {
                recipientsBody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--color-text-secondary);">××™×Ÿ × ××¢× ×™× × ×•×¡×¤×™×. ×”××™××™×™×œ × ×©×œ×— ×¨×§ ×œ×›×ª×•×‘×ª ×”×¨××©×™×ª.</td></tr>';
                return;
            }
            recipientsBody.innerHTML = recipients.map((r, i) => {
                const statusBadge = r.enabled !== false
                    ? '<span class="status-badge status-badge--active">×¤×¢×™×œ</span>'
                    : '<span class="status-badge status-badge--disabled">××•×©×‘×ª</span>';
                return `<tr>
                    <td dir="ltr" style="font-family: monospace;">${esc(r.email)}</td>
                    <td>${esc(r.name || "â€”")}</td>
                    <td>${statusBadge}</td>
                    <td style="white-space: nowrap;">
                        <button class="btn btn--small ${r.enabled !== false ? 'btn--danger' : 'btn--primary'}"
                                data-raction="toggle" data-rindex="${i}">
                            ${r.enabled !== false ? '×”×©×‘×ª' : '×”×¤×¢×œ'}
                        </button>
                        <button class="btn btn--small btn--danger" data-raction="delete" data-rindex="${i}"
                                style="margin-top: 4px;">××—×§</button>
                    </td>
                </tr>`;
            }).join("");
        }

        // Recipients table event delegation
        recipientsBody.addEventListener("click", (e) => {
            const btn = e.target.closest("[data-raction]");
            if (!btn) return;
            const idx = parseInt(btn.dataset.rindex);
            if (btn.dataset.raction === "toggle") {
                recipients[idx].enabled = recipients[idx].enabled === false ? true : false;
                renderRecipients();
                markChanged();
            } else if (btn.dataset.raction === "delete") {
                if (confirm(`×œ×”×¡×™×¨ ××ª ${recipients[idx].email}?`)) {
                    recipients.splice(idx, 1);
                    renderRecipients();
                    markChanged();
                }
            }
        });

        // Add recipient
        document.getElementById("addRecipientBtn").addEventListener("click", () => {
            const email = document.getElementById("newRecipientEmail").value.trim();
            const name = document.getElementById("newRecipientName").value.trim();
            const msg = document.getElementById("addRecipientMsg");
            if (!email || !email.includes("@")) {
                msg.textContent = "× × ×œ×”×›× ×™×¡ ×›×ª×•×‘×ª ××™××™×™×œ ×ª×§×™× ×”";
                msg.style.color = "#dc2626";
                return;
            }
            if (recipients.some(r => r.email === email)) {
                msg.textContent = "×›×ª×•×‘×ª ×–×• ×›×‘×¨ ×‘×¨×©×™××”!";
                msg.style.color = "#dc2626";
                return;
            }
            recipients.push({ email, name: name || "", enabled: true });
            renderRecipients();
            markChanged();
            document.getElementById("newRecipientEmail").value = "";
            document.getElementById("newRecipientName").value = "";
            msg.textContent = "× ××¢×Ÿ × ×•×¡×£! ×œ×—×¥ '×©××•×¨ ×œ×¨×™×¤×•' ×›×“×™ ×œ×©××•×¨.";
            msg.style.color = "#059669";
            setTimeout(() => { msg.textContent = ""; }, 4000);
        });

        // === Source Management ===

        function markChanged() {
            hasChanges = true;
            saveBar.classList.add("visible");
        }

        function sourceRow(s, i) {
            const catBadge = s.category === "ai"
                ? '<span class="card__badge card__badge--ai">ğŸ¤– AI</span>'
                : '<span class="card__badge card__badge--cyber">ğŸ”’ ×¡×™×™×‘×¨</span>';
            const statusBadge = s.enabled
                ? '<span class="status-badge status-badge--active">×¤×¢×™×œ</span>'
                : '<span class="status-badge status-badge--disabled">××•×©×‘×ª</span>';
            const method = s.method === "rss" ? "RSS" : "Scraping";

            return `<tr>
                <td>
                    <strong>${esc(s.name)}</strong><br>
                    <a href="${esc(s.url)}" target="_blank" rel="noopener"
                       style="font-size: 0.8rem; color: var(--color-link);">${esc(s.url)}</a>
                </td>
                <td>${catBadge}</td>
                <td>${method}</td>
                <td>${statusBadge}</td>
                <td style="white-space: nowrap;">
                    <button class="btn btn--small ${s.enabled ? 'btn--danger' : 'btn--primary'}"
                            data-action="toggle" data-index="${i}">
                        ${s.enabled ? '×”×©×‘×ª' : '×”×¤×¢×œ'}
                    </button>
                    <button class="btn btn--small btn--danger" data-action="delete" data-index="${i}"
                            style="margin-top: 4px;">××—×§</button>
                </td>
            </tr>`;
        }

        function renderSources() {
            sourceCount.textContent = sources.length;

            if (sources.length === 0) {
                sourcesBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">××™×Ÿ ××§×•×¨×•×ª</td></tr>';
                return;
            }

            // Sort: AI first, then Cyber, alphabetical within each group
            const indexed = sources.map((s, i) => ({ s, i }));
            indexed.sort((a, b) => {
                if (a.s.category !== b.s.category) {
                    return a.s.category === "ai" ? -1 : 1;
                }
                return (a.s.name || "").localeCompare(b.s.name || "");
            });

            const aiCount = sources.filter(s => s.category === "ai").length;
            const cyberCount = sources.filter(s => s.category === "cyber").length;

            let html = "";

            // AI section header
            html += `<tr><td colspan="5" style="background: #f3e8ff; padding: 10px 16px; font-weight: 700; font-size: 1.05rem; color: #7c3aed;">
                ğŸ¤– AI (${aiCount})
            </td></tr>`;

            for (const { s, i } of indexed.filter(x => x.s.category === "ai")) {
                html += sourceRow(s, i);
            }

            // Cyber section header
            html += `<tr><td colspan="5" style="background: #d1fae5; padding: 10px 16px; font-weight: 700; font-size: 1.05rem; color: #047857;">
                ğŸ”’ ×¡×™×™×‘×¨ (${cyberCount})
            </td></tr>`;

            for (const { s, i } of indexed.filter(x => x.s.category === "cyber")) {
                html += sourceRow(s, i);
            }

            sourcesBody.innerHTML = html;
        }

        // Event delegation for table buttons
        document.getElementById("sourcesBody").addEventListener("click", (e) => {
            const btn = e.target.closest("[data-action]");
            if (!btn) return;
            const idx = parseInt(btn.dataset.index);
            if (btn.dataset.action === "toggle") {
                sources[idx].enabled = !sources[idx].enabled;
                renderSources();
                markChanged();
            } else if (btn.dataset.action === "delete") {
                if (confirm(`×œ××—×•×§ ××ª "${sources[idx].name}"?`)) {
                    sources.splice(idx, 1);
                    renderSources();
                    markChanged();
                }
            }
        });

        // Add source
        document.getElementById("addSourceBtn").addEventListener("click", () => {
            const name = document.getElementById("sourceName").value.trim();
            const url = document.getElementById("sourceUrl").value.trim();
            const rssUrl = document.getElementById("sourceRssUrl").value.trim();
            const category = document.getElementById("sourceCategory").value;
            const msg = document.getElementById("addSourceMsg");

            if (!name || !url) {
                msg.textContent = "× × ×œ××œ× ×©× ×•×›×ª×•×‘×ª";
                msg.style.color = "#dc2626";
                return;
            }
            if (sources.some(s => s.url === url)) {
                msg.textContent = "××§×•×¨ ×–×” ×›×‘×¨ ×§×™×™×!";
                msg.style.color = "#dc2626";
                return;
            }

            sources.push({
                name,
                url,
                rss_url: rssUrl || null,
                category,
                enabled: true,
                method: rssUrl ? "rss" : "scrape",
            });

            renderSources();
            markChanged();
            document.getElementById("sourceName").value = "";
            document.getElementById("sourceUrl").value = "";
            document.getElementById("sourceRssUrl").value = "";
            msg.textContent = "×”××§×•×¨ × ×•×¡×£! ×œ×—×¥ '×©××•×¨ ×œ×¨×™×¤×•' ×›×“×™ ×œ×©××•×¨.";
            msg.style.color = "#059669";
            setTimeout(() => { msg.textContent = ""; }, 4000);
        });

        // Save / Discard
        document.getElementById("saveBtn").addEventListener("click", saveToRepo);
        document.getElementById("discardBtn").addEventListener("click", () => {
            const parsed = JSON.parse(originalJson);
            sources = parsed.sources || [];
            const parsedR = JSON.parse(originalRecipientsJson || '{"recipients":[]}');
            recipients = parsedR.recipients || [];
            hasChanges = false;
            saveBar.classList.remove("visible");
            renderSources();
            renderRecipients();
            log("×”×©×™× ×•×™×™× ×‘×•×˜×œ×•.");
        });

        // Warn before leaving with unsaved changes
        window.addEventListener("beforeunload", (e) => {
            if (hasChanges) {
                e.preventDefault();
                e.returnValue = "";
            }
        });

        // === Helpers ===

        function esc(text) {
            if (!text) return "";
            const d = document.createElement("div");
            d.textContent = text;
            return d.innerHTML;
        }

        function log(text) {
            statusLog.textContent = text;
        }

        // Init
        init();
    })();
    </script>
</body>
</html>
